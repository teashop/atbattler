<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ATBattler GameInstance Tests</title>
  <link rel="stylesheet" href="resources/qunit-1.10.0.css">
</head>
<body>
  <div id="qunit"></div>
  <script src="resources/qunit-1.10.0.js"></script>
  <script src="../js/vendor/underscore-min.js"></script>
  <script src="../js/vendor/jquery-1.8.2.min.js"></script>

  <script src="../js/util.js"></script>
  <script>
  test( "EventQueue - basic success cases", function() {
    var numElements = 0;
    function cb(num) {
      numElements = num;
    }
    var eq = new EventQueue(cb);
        
    // is empty
    equal( eq.length(), 0, "Queue is empty" );

    // single push
    eq.push('1');
    equal( eq.length(), 1, "Queue has 1 element" );
    equal( numElements, 1, "Callback reported that 1 element was added" );

    // add a couple more elements
    eq.push('2');
    eq.push('3');
    eq.push('4');
    equal( eq.length(), 4, "Queue now has 4 elements" );

    // single shift, blank arg
    eq.shift();
    equal( eq.length(), 3, "single shift, blank args: Queue now has 3 elements" );
    eq.shift(1);
    equal( eq.length(), 2, "single shift, arg=1: Queue now has 2 elements" );
    var result = eq.shift(2);
    equal( eq.length(), 0, "multi shift, arg=2: Queue now empty" )
    ok( result.length==2 && result[0]=='3' && result[1]=='4', "multi shift result: 2: Queue now empty, and results were ['3','4']" );

  });

  test( "EventQueue - the buffer", function() {
    var numElements = 0;
    function cb(num) {
      numElements = num;
    }
    var eq = new EventQueue(cb);

    // add some stuff to the buffer
    eq.buffer('1');
    eq.buffer('2');
    eq.buffer('3');

    equal( eq.length(), 0, "Queue is empty (elements buffered)" );
    equal( eq.bufferLength(), 3, "Buffer now has 3 elements" );


    // flush buffer
    eq.flush();
    equal( numElements, 3, "3 elements were flushed from buffer to queue!" );
    equal( eq.length(), 3, "The queue now has 3 elements" );
    equal( eq.bufferLength(), 0, "Buffer is now empty (elements flushed)" );

    // flushing empty buffer has no effect
    eq.flush();
    equal( eq.length(), 3, "The queue *still* has 3 elements" );

    // add to buffer, add to queue
    eq.buffer('a');
    eq.push('b');
    ok( eq.length() == 4 && eq.bufferLength() == 1, "Buffer and queue operate independently");

    // shifting doesn't impact buffer
    eq.shift();
    ok( eq.length() == 3 && eq.bufferLength() == 1, "Shifting from queue doesn't impact buffer");

    // clear() clears both
    eq.clear();
    ok( eq.length() == 0 && eq.bufferLength() == 0, "clear() clears both buffer and queue");

  });

  test( "EventQueue - error cases", function() {
    var theEx = null;

    // callback is a required parameter 
    try {
      var eq = new EventQueue();
      eq.push('1');
    } catch (exception) {
      theEx = exception;
    }
    ok(theEx != null, "Callback function is required");

    var numElements = 0;
    function cb(num) {
      numElements = num;
    }
    var eq = new EventQueue(cb);

    // shift on empty queue
    var result = eq.shift();
    equal( eq.length(), 0, "shift() on empty queue does nothing");
    ok( !result, "the result should be undefined"); 

    // multi shift on empty queue
    var result = eq.shift(3);
    ok( result.length == 0, "the result should be empty []");
  });
  </script>
</body>
</html>
