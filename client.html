<!DOCTYPE html>
<html>
<head>
  <title>ATBattler v0.1</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/atbattler.css"/>
  <script src="js/vendor/jquery-1.8.2.min.js"></script>
  <script src="js/vendor/underscore-min.js"></script>
  <script src="js/vendor/async.min.js"></script>
  <script src="js/vendor/state-machine.min.js"></script>
  <script src="js/vendor/easeljs-0.5.0.min.js"></script>
  <script src="js/vendor/tweenjs-0.3.0.min.js"></script>
  <script src="js/vendor/preloadjs-0.2.0.min.js"></script>
  <script src="js/vendor/jquery.hotkeys-0.8.js"></script>
  <script src="js/domain.js"></script>
  <script src="js/util.js"></script>
  <script src="js/durationevent.js"></script>
  <script src="js/gameevent.js"></script>
  <script src="js/item.js"></script>
  <script src="js/gameinstance.js"></script>
  <script src="js/gameclient.js"></script>
  <script src="js/view.js"></script>

  <!-- EaselJS setup -->
  <script type="text/javascript">
    var FPS = 30;
    var SECOND = 1000;  // a second is 1000ms
    var msPerFrame = SECOND/FPS; // approximate
    var HERO_BASE_X = 150;
    var HERO_BASE_Y = 150;
    var HERO_BASE_SCALE = 3;
    var HERO_SPACE_X = 15;
    var HERO_SPACE_Y = 65;
    var HERO_PERSPECTIVE_SCALE = 0.15;

    var backdrop;
    var stage;
    var runningRate = 2.5;
    var w, h;
    var counter = 0;  // duration of game (temp)
    var effectNumGen; // dem popping numbers

    // TODO: have this determined by the game
    // Use tag loading for now.
    var preload = new createjs.PreloadJS(false);
    var manifest = [
        "img/plains.png",
        "img/amber.png",
        "img/jergens.png",
        "img/chara01.png"
      ];
    preload.onComplete = init;
    preload.loadManifest(manifest);


    var heroSprites = [];
    var enemySprites = [];

    var heroIdToSprite = [];  // maps heroes to sprites

    function init() {
      // create a new stage and point it at our canvas:
      var canvas =document.getElementById("main-canvas");
      stage = new createjs.Stage(canvas);
    
      // grab canvas width and height for later calculations:
      w = canvas.width;
      h = canvas.height;

      var bgImage = new Image();
      bgImage.src = 'img/plains.png';

      // Add backdrop to the stage
      backdrop =  new createjs.Shape(new createjs.Graphics().beginBitmapFill(bgImage, 'no-repeat').drawRect(0,0,bgImage.width,bgImage.height));
      backdrop.scaleX = Math.ceil(w/bgImage.width);
      backdrop.scaleY = Math.ceil(h/bgImage.height);
      stage.addChild(backdrop);

      // add elapsed time counter to stage
      elapsedLabel = new createjs.Text("0s","bold 14px Arial","#FFF");
      stage.addChild(elapsedLabel);
      elapsedLabel.x = 10;
      elapsedLabel.y = 10;

      // TODO: hero sprites should be tied to their domain counterparts
      // properly.  We're just arbitrarily mapping them here.
      var jergensSheet = new createjs.SpriteSheet({
        "animations": {
          "idle": [22],
          "walk": [21,23, "walk", 5]
          },
          "images": ["img/jergens.png"],
          "frames": {
              "height": 32,
              "width":24,
              "regX": 16,
              "regY": 12,
              "count": 96
            }
       });
      var miltonSheet = new createjs.SpriteSheet({
        "animations": {
          "idle": [13],
          "walk": [12,14, "walk", 5]
          },
          "images": ["img/jergens.png"],
          "frames": {
              "height": 32,
              "width":24,
              "regX": 16,
              "regY": 12,
              "count": 96
            }
       });
      var harukaSheet = new createjs.SpriteSheet({
        "animations": {
          "idle": [64],
          "walk": [63,65, "walk", 5]
          },
          "images": ["img/amber.png"],
          "frames": {
              "height": 32,
              "width":24,
              "regX": 16,
              "regY": 12,
              "count": 96
            }
       });
      var leenaSheet = new createjs.SpriteSheet({
        "animations": {
          "idle": [61],
          "walk": [60,62, "walk", 5]
          },
          "images": ["img/jergens.png"],
          "frames": {
              "height": 32,
              "width":24,
              "regX": 16,
              "regY": 12,
              "count": 96
            }
       });
      heroSprites.push(new createjs.BitmapAnimation(jergensSheet));
      heroSprites.push(new createjs.BitmapAnimation(miltonSheet));
      heroSprites.push(new createjs.BitmapAnimation(harukaSheet));
      heroSprites.push(new createjs.BitmapAnimation(leenaSheet));
      for (var i = 0, len = heroSprites.length; i < len; i++) {
        var curSprite = heroSprites[i];
        curSprite.x = HERO_BASE_X - HERO_SPACE_X*i - 10*i;
        curSprite.origX = curSprite.x;
        curSprite.y = HERO_BASE_Y + HERO_SPACE_Y*i;
        curSprite.origY = curSprite.y;
        curSprite.scaleX = curSprite.scaleY = HERO_BASE_SCALE-((len-i)*HERO_PERSPECTIVE_SCALE);
        curSprite.gotoAndPlay("idle");
        stage.addChild(curSprite);
      }
      // enemy sprites
      var badguySheet = new createjs.SpriteSheet({
        "animations": {
          "idle": [43],
          "walk": [42,44, "walk", 5]
          },
          "images": ["img/chara01.png"],
          "frames": {
              "height": 32,
              "width":24,
              "regX": 16,
              "regY": 12,
              "count": 96
            }
       });
      var wagsSheet = new createjs.SpriteSheet({
        "animations": {
          "idle": [37],
          "walk": [36,38, "walk", 5]
          },
          "images": ["img/chara01.png"],
          "frames": {
              "height": 32,
              "width":24,
              "regX": 16,
              "regY": 12,
              "count": 96
            }
       });
      enemySprites.push(new createjs.BitmapAnimation(badguySheet));
      enemySprites.push(new createjs.BitmapAnimation(wagsSheet));
      for (var i = 0, len = enemySprites.length; i < len; i++) {
        var curSprite = enemySprites[i];
        curSprite.x = w-HERO_BASE_X + HERO_SPACE_X*i + 10*i;
        curSprite.origX = curSprite.x;
        curSprite.y = HERO_BASE_Y + HERO_SPACE_Y*i;
        curSprite.origY = curSprite.y;
        curSprite.scaleX = curSprite.scaleY = HERO_BASE_SCALE-((len-i)*HERO_PERSPECTIVE_SCALE);
        curSprite.gotoAndPlay("idle");
        stage.addChild(curSprite);
      }

      heroIdToSprite[1] = heroSprites[0];
      heroIdToSprite[2] = heroSprites[1];
      heroIdToSprite[3] = heroSprites[2];
      heroIdToSprite[4] = heroSprites[3];
      heroIdToSprite[100] = enemySprites[0];
      heroIdToSprite[200] = enemySprites[1];

      effectNumGen = new atb.EffectNumberGenerator(stage);
      stage.update();
    }

    // the view's game loop
    function tick() {
      //fpsLabel.text = Math.round(createjs.Ticker.getMeasuredFPS())+" fps";
      var toUpdate = gameClient.update();
      if (toUpdate && toUpdate.length > 0) {
        // _.each(toUpdate, updateHero);
        for (var i = 0, len = toUpdate.length; i < len; i++) {
          updateHero(toUpdate[i]);
        }
      }
      elapsedLabel.text = counter + "s";
      stage.update();
    }
  </script>

  <style>
    #commands-anchor {
      position: absolute;
      top: 0;
      min-height: 300px;
      width:200px;
      left: 375px;
      overflow: hidden;
    }
    .menu-nested-pane {
      background-color: rgba(10, 50, 110, 0.9);
      margin: 0 10px;
      float: left;
      position: relative;
      z-index: 2;
      width: 158px;
    }
    .menu-nested-pane ul {
      list-style-type: none;
      list-style-position: inside;
      margin: 0;
      padding: 0;
    }
    .menu-nested-pane li {
      position: relative;
    }
    /* Selected Menu Item pointer */
    .menu-nested-pane li.selected:before {
      content: url('img/pointer.png');
      left: -18px;
      top: 2px;
      z-index: 1000;
      position: absolute;
    }
    .menu-nested-pane a {
      border-radius: 4px;
      color: #eee;
      display: block;
      padding: 4px 10px;
      text-decoration: none;
      background-color: rgba(38,128,208,0);
      -webkit-transition: background-color 0.2s ease-out 0s;
      -ms-transition: background-color 0.2s ease-out 0s;
      -o-transition: background-color 0.2s ease-out 0s;
      transition: background-color 0.2s ease-out 0s;
    }
    .menu-nested-pane a:hover, .menu-nested-pane li.selected a {
      background-color: rgba(38,128,208,0.8);
    }

    .menu-nested-pane .pane-title {
      margin-bottom: 8px;
    }

    .command-tray {
      position:relative;
      width:1600px;left:0px;
    }

    .command-pane {
      min-height: 120px;
      z-index:3;
    }

    .target-menu {
      display: block;
      position: absolute;
      top: 25px;
      left: 450px;
      z-index:5;
    }

    .item-menu {
      display: block;
      height: 160px;
      left: 230px;
      position: absolute;
      top: 0px;
      width: 630px;
      z-index:4;
    }
    .item-menu .tooltip {
      background-color: rgba(0, 25, 70, 0.9);
      font-weight: normal;
      padding: 5px 10px;
      margin: 0 0 10px 0;
    }
    .item-list {
      overflow-y: scroll;
      height: 120px;
    }
    .item-menu li {
      width: 280px;
      float: left;
      margin-left: 20px;
    }
    .item-menu li .qty {
      float: right;
      display: block;
    }

    #party .selected {
      background-color: rgba(10, 50, 110, 0.9);
    }
    #player-pane {
      left: 0px;
      height:160px;
      position: absolute;
      width: 480px;
    }
    #enemy-pane {
      left: 500px;
      height:160px;
      position: absolute;
      width: 440px;
    }

    .hero-list {
      border: none;
      border-collapse:collapse;
    }
    .hero-list td {
      padding: 6px 12px;
    }
    .hero-list td.hp {
      width: 50px;
      text-align: right;
    }
    .hero-list th {
      font-size: 12px;
      font-weight: normal;
    }

    #pause, #resume, #start {
      background-color: #37c;
      border: 1px solid rgb(48, 121, 237);
      border-radius: 2px;
      color: white;
      cursor: pointer;
      display:none;
      float:right;
      font-family: arial;
      font-weight: bold;
      padding: 5px 10px;
    }
    #pause:hover, #resume:hover, #start:hover {
      background-color: #59e;
    }

    #command-next, #command-prev {
      background-color: #37c;
      border: 1px solid rgb(48, 121, 237);
      border-radius: 2px;
      color: white;
      display: none;
      font-family: arial;
      font-weight: bold;
      left: 524px;
      position: absolute;
      width: 30px;
      height: 25px;
      padding-bottom: 2px;
      z-index:3;
    }
    #command-prev {
      left: 394px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="width:960px;">
      <h1 class="logo"><span class="atb"><strong>AT</strong>B</span>attler</h1>
      <span class="fineprint">v0.1</span>
      <button id="pause"/>Pause Game</button>
      <button id="resume"/>Resume Game</button>
      <button id="start"/>Start Game</button>
    </div>
    <div> 
      <canvas id="main-canvas" height="460" width="960">
      </canvas>
      <div style="position:relative;height:165px;">
        <div id="player-pane" class="menu-pane">
          <div id="commands-anchor"></div>
          <button id="command-prev" onClick="commandCarousel.moveRight();">&laquo;</button>
          <button id="command-next" onClick="commandCarousel.moveLeft();">&raquo;</button>
          <table id="party" class="hero-list">
            <thead>
              <th>Name</th>
              <th>HP</th>
              <th>SP</th>
              <th></th>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <div id="enemy-pane" class="menu-pane">
          <table id="enemy" class="hero-list">
            <thead>
              <th>Name</th>
              <th>HP</th>
              <th>SP</th>
              <th></th>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div> 
      </div>
      <br style="clear:both;"/>
      <div id="combatLog">
        <ul>
        </ul>
      </div>
    </div>
    <script type="text/javascript">
      /** View stuff */
      var hpIncrementers = [];
      var heroRows = [];

      /** Templates **/
      // Hero Row (name, hp, gauge, etc)
      var heroRowTemplate = _.template('<tr id="<%= heroDomId %>" class="hero"'
        + 'position="<%= position %>" heroId="<%= heroId %>"><td>'
        + '<%= heroName %></td><td class="hp"><%= heroHp %></td>'
        + '<td class="sp"></td><td class="gauge"><div class="gauge-container"><div class="gauge-bar"></div></div></td></tr>'
         );

      /**
       * Hero Command Menu Content
       */
      var heroCommandPaneTemplate = _.template(
        '<div id="com_<%= hero.id %>" heroId="<%= hero.id %>" class="menu-nested-pane">'
        + '<div class="pane-title"><%= hero.name %></div>'
        + '<div id="comlist_<%= hero.id %>" class="command-list"></div>'
        + '</div>');

      // Hero Command list
      var heroCommandTemplate = _.template('<a href="#"><%= command.name %></a>');

      // Target Menu 
      var heroTargetMenuTemplate = _.template('<div id="tarlist_<%= hero.id %>"  heroId="<%= hero.id %>" class="target-menu menu-nested-pane"><div class="target-list"></div></div>');

      // Target Menu list item
      var heroTargetTemplate =  _.template('<a href="#" class="<%= actionType %>" heroId="<%= heroId %>" targetId="<%= target.id %>"><%= target.name %></a>');

      // Cancel (close nested menu) list item
      var heroCancelTemplate =  _.template('<a href="#" class="cancel" heroId="<%= heroId %>">Cancel</a>');

      // Item Menu
      var heroItemMenuTemplate = _.template('<div id="item_menu_<%= hero.id %>"  heroId="<%= hero.id %>" class="item-menu menu-nested-pane"><div class="tooltip"></div><div id="item_list_<%= hero.id %>" class="item-list"></div></div>');
      // Item Menu list item
      var heroItemTemplate =  _.template('<a href="#" id="it_<%= item[atb.Item.field.id] %>" heroId="<%= heroId %>"><%= item[atb.Item.field.name] %><div class="qty"><%= qty %></div></a>');

      /** END Templates **/

      /** INVENTORY **/
      // TODO: have an inventory, this is hardcoded:
      var inventory = [
          {item: atb.Item[0], qty: 10},
          {item: atb.Item[1], qty: 10},
          {item: atb.Item[2], qty: 10},
          {item: atb.Item[3], qty: 10}
        ];
      /** END INVENTORY **/

      function updateHero(hero) {
        var player = hero.player;
        var isYou = player.id == gameClient.myId;
        var heroRow = heroRows[hero.id];
        var heroGauge = heroRow.find('div.gauge-bar');
        // don't update dead people!
        if (hero.statuses.dead) {
          if (!heroRow.hasClass('dead')) {
            heroRow.addClass('dead');
            var heroSprite = heroIdToSprite[hero.id];
            atb.tweenHeroDead(heroSprite, hero.player != gameClient.me, heroSprite.origX, heroSprite.origY);
            updateHeroHp(hero, null, 0);
          }
          return;
        }
        // update gauge
        heroGauge.width(hero.turnGauge + '%');
        // update readiness
        if (hero.statuses.ready && isYou && !heroRow.hasClass('ready')) {
          var heroDomId = '#hero_'+ hero.id;
          var commands = hero.commands;
          var comMenu = new atb.Menu(heroCommandPaneTemplate, {hero: hero});

          // populate with menu items
          var comToMenuItems = _.map(commands, function(command) {
              return heroCommandTemplate({command: command})
            });
          comMenu.addMenuItems('.command-list');
          comMenu.items.isWrapAround = true;
          comMenu.items.addItems(comToMenuItems);
          comMenu.onKeyInput = comMenuKeyInputHandler.bind(comMenu);
          comMenu.onPreClose = function() { return commandCarousel.remove(hero.id); };
          comMenu.container.data('menu', comMenu);

          // FIXME:
          // add to command carousel 
          commandCarousel.add(comMenu, hero.id)
          if (!activeMenu) {
            setActiveMenu(comMenu);
          }

          heroRow.addClass('ready');
        }
      }

      function updateHeroHp(hero, type, amount, isCrit) {
        // update hp
        if (type) {
          // let incrementer take care of update
          hpIncrementers[hero.id].setTarget(hero.attributes.hp);
          switch (type) {
            case 'attack':
            case 'skill':
              atb.tweenHeroHit(heroIdToSprite[hero.id], hero.player != gameClient.me, heroIdToSprite[hero.id].origX);
              effectNumGen.generate(amount, isCrit, heroIdToSprite[hero.id]);
              break;
            case 'item':
              effectNumGen.generate(amount, isCrit, heroIdToSprite[hero.id], 'heal');
              break;
            default:
              console.log('unknown type, using default increment');
              effectNumGen.generate(amount, isCrit, heroIdToSprite[hero.id]);
              break;
          }
        } else {
          // stop any existing incrementer, then set your value
          var heroHp = heroRows[hero.id].find('.hp');
          hpIncrementers[hero.id].complete();
          heroHp.text(hero.attributes.hp);
        }
      }

      // take action => reset hero & update targets 
      function takeAction(hero, target, type, amount, isCrit) {
        resetHero(hero);
        updateHeroHp(target, type, amount, isCrit);
      }

      function resetHero(hero) {
        var heroRow = heroRows[hero.id];
        hero.statuses.ready = false;
        hero.turnGauge = 0.00;
        heroRow.removeClass('ready');
        updateHero(hero);
      }

      function cancelTargetPane(toClose) {
        var menuAnchor = $('#player-pane');
        targetMenu = menuAnchor.find('.target-menu');
        if (targetMenu.length > 0) {
          targetMenu = targetMenu.data('menu');
          targetMenu.close();
        }
      }

      // target list => execute action on target.
      $('#player-pane').on('click', '.target-menu a', function(event) {
          var actionType = $(this).prop('class');
          var actorId = $(this).attr('heroId');
          var targetId = $(this).attr('targetId');
          var actionArgs = activeMenu.container.data('args');

          // TODO: move this out
          if (actionType == 'cancel') {
            // backtrack to command menu
            cancelTargetPane();
          } else {
            executeCommandOnTarget(actionType, actionArgs, actorId, targetId);
          }
          return false;
      });

      function executeCommandOnTarget(actionType, actionArgs, actorId, targetId) {
        var hero = gameClient.heroes[actorId];
        var target = gameClient.heroes[targetId];
        switch (actionType) {
          case 'attack':
            gameClient.queueEvent(GameEvent.type.player_action, {type: 'attack', by: hero.id, target: target.id});
            break;
          case 'skill':
            gameClient.queueEvent(GameEvent.type.player_action, {type: 'skill', by: hero.id, target: target.id});
            break;
          case 'item':
            // Item takes the Item ID as an argument
            var itemId = actionArgs;
            gameClient.queueEvent(GameEvent.type.player_action, {type: 'item', id: itemId, by: hero.id, target: target.id});
            break;
          default:
            console.log('Action Not Yet Impl: ' + actionType);
            break;
        }
        activeMenu.cascadeClose();
      }

      // command list item => process the command
      $('#player-pane').on('click', '.command-pane .command-list a', function(event) {
          var commandPane = $(event.target).parents('.command-pane');
          var actionType = $(this).text().toLowerCase();
          processCommand(commandPane, actionType);
          return false;
      });

      function processCommand(commandPane, actionType) {
        var heroId = commandPane.attr('heroId');
        var hero = gameClient.heroes[heroId];
        switch (actionType) {
          case 'attack':
          case 'skill':
            openTargetMenu(hero, actionType, null, activeMenu);
            break;
          case 'item':
            openItemMenu(hero, activeMenu);
            break;
          default:
            console.log('Command Not Yet Impl: ' + actionType);
            break;
        }
      }
      
      // "Item" command menu
      function openItemMenu(hero, parentMenu) {
        var menuAnchor = $('#player-pane');
        var itemMenu = new atb.Menu(heroItemMenuTemplate, {hero: hero}, parentMenu);
        menuAnchor.append(itemMenu.container);

        // populate with items in inventory.
        var itemToMenuItems = _.compact(_.map(inventory, function(slot) {
            return heroItemTemplate({heroId: hero.id, item: slot.item, qty: slot.qty});
          }));

        itemToMenuItems.push(heroCancelTemplate({heroId: hero.id}));
        itemMenu.addMenuItems('.item-list');
        itemMenu.items.isWrapAround = false;
        itemMenu.items.itemsPerRow = 2;
        itemMenu.items.onSelect = function(selected) {
          var domId = selected.prop('id');
          var itemId = domId.substr(domId.lastIndexOf('_')+1);
          itemMenu.container.find('.tooltip').html(atb.Item[itemId][atb.Item.field.desc]);
        }
        itemMenu.items.addItems(itemToMenuItems);
        itemMenu.onKeyInput = itemMenuKeyInputHandler.bind(itemMenu);
        itemMenu.onClose = (function() { setActiveMenu(this.parentMenu) }).bind(itemMenu);
        itemMenu.container.data('menu', itemMenu);
        setActiveMenu(itemMenu);
        itemMenu.container.show();
      }

      // Target Selection Menu
      function openTargetMenu(hero, actionType, actionArgs, parentMenu) {
        var targets = null;
        switch (actionType) {
          case 'attack':
            targets = gameClient.enemy.party.heroes;
            break;
          case 'skill':
            targets = gameClient.enemy.party.heroes;
            break;
          case 'item':
            targets = gameClient.me.party.heroes;
            break;
          default:
            console.log('Command Not Yet Impl: ' + actionType);
            break;
        }
        if (targets) {
          var menuAnchor = $('#player-pane');
          var tarMenu = new atb.Menu(heroTargetMenuTemplate, {hero: hero}, parentMenu);
          menuAnchor.append(tarMenu.container);

          // populate with target list as menu items
          var tarToMenuItems = _.compact(_.map(targets, function(target) {
              if (target.statuses.dead) { 
                return null;
              } else {
                return heroTargetTemplate({actionType: actionType, heroId: hero.id, target: target});
              }
            }));
          tarToMenuItems.push(heroCancelTemplate({heroId: hero.id}));
          tarMenu.addMenuItems('.target-list');
          tarMenu.items.isWrapAround = true;
          tarMenu.items.addItems(tarToMenuItems);

          tarMenu.onKeyInput = tarMenuKeyInputHandler.bind(tarMenu);
          tarMenu.onClose = (function() { setActiveMenu(this.parentMenu) }).bind(tarMenu);
          tarMenu.container.data('menu', tarMenu);
          if (actionArgs) {
            tarMenu.container.data('args', actionArgs);
          }
          setActiveMenu(tarMenu);
          tarMenu.container.show();
        }
      }

      // show/hide nav buttons for command pane if necessary
      function showCommandNavButtons() {
        $('#command-next').slideDown(100);
        $('#command-prev').slideDown(100);
      }
      function hideCommandNavButtons() {
        $('#command-next').slideUp(100);
        $('#command-prev').slideUp(100);
      }

      function onAddRemoveCommandPanes(numPanes) {
        if (numPanes > 1) {
          showCommandNavButtons();
        } else {
          hideCommandNavButtons();
        }
      }

      function onCommandCarouselMoveStart(id) {
        if (id) {
          $('#hero_'+ id).removeClass('selected');
          hideCommandNavButtons();
        }
      }
      function onCommandCarouselMoveEnd(id) {
        if (id) {
          $('#hero_'+ id).addClass('selected');
          setActiveMenu(commandCarousel.getPaneInFocus().data('menu'));
          if (commandCarousel.numPanes > 1) {
            showCommandNavButtons();
          }
        } else {
          setActiveMenu(null);
        }
      }

      // Start Game
      $('#start').on('click', function(event) {
          gameClient.ready();
          $(this).hide();
          });

      // Pause Game
      $('#pause').on('click', function(event) {
          gameClient.requestPause();
          $(this).hide();
          $('#resume').show();
          });

      // Resume Game
      $('#resume').on('click', function(event) {
          gameClient.requestResume();
          $(this).hide();
          $('#pause').show();
          });

      /** END View stuff */
      

      // TODO: much of this should be 'server side'.
      var clock = new Clock(msPerFrame);
      var gameInstance = new GameInstance(clock);
      // *YOU
      var player = new Player(1, 'You');
      var party = new Party(1, 4);
      party.setHero(rollPlayerHero(1, 'Jergens'));
      party.setHero(rollPlayerHero(2, 'Milton'));
      party.setHero(rollPlayerHero(3, 'Haruka'));
      party.setHero(rollPlayerHero(4, 'Leena'));
      player.setParty(party);
      player.sendMessage = function(message) {
//        console.log('Player got msg: ' + message);
        gameClient.eventsIn.push(message);
      };

      // *OPPONENT
      var enemy = new Player(2, 'Enemy');
      var enemyParty = new Party(1, 4);
      enemyParty.setHero(rollCpuHero(100, 'Teh Badguy'));
      enemyParty.setHero(rollCpuHero(200, 'Wagglerstein'));
      enemy.setParty(enemyParty);
      enemy.sendMessage = function(message) {
//        console.log('CPU got msg: ' + message);
        cpuGameClient.eventsIn.push(message);
      }

      gameInstance.addPlayers(player, enemy);

      function emitterCallback() {
        var type = arguments[0];
        var args = arguments[1] ? arguments[1] : null;

        // View handling of events raised by the Client.
        switch(type) {
          case 'clientLogEvent': 
            var msg = args;
            // FIXME: no limit to messages!
            var combatLog = $('#combatLog');
            var combatLogList = combatLog.find('ul');
            combatLogList.append('<li>'+msg+'</li>');
    //        combatLog.scrollTop(combatLogList.height());
            break;
          case 'clientGameOverEvent':
            var msg = args;
            commandCarousel.clear();
            $('tr', '#party').removeClass('selected');
            // FIXME: arbitrary 1s for animations to complete
            _.delay(function() { createjs.Ticker.setPaused(true); }, 1000);
            gameOverLabel = new createjs.Text(msg, "bold 40px Arial","#FFF");
            stage.addChild(gameOverLabel);
            gameOverLabel.x = 50;
            gameOverLabel.y = 100;
            stage.update();
            break;
          case 'clientSetupCompleteEvent':
            $('#start').show();
            break;
          case 'clientGameStartEvent':
            createjs.Ticker.setFPS(FPS);
            createjs.Ticker.useRAF = true;
            createjs.Ticker.addListener(window);
            $('#pause').show();
            break;
          case 'clientGamePauseEvent':
            createjs.Ticker.setPaused(true);
            break;
          case 'clientGameResumeEvent':
            createjs.Ticker.setPaused(false);
            break;
          case 'clientUpdateHeroEvent':
            var hero = args;
            updateHero(hero);
            break;
          case 'clientHeroActionEvent':
            // source, target, type, amount, isCrit
            takeAction(args[0], args[1], args[2], args[3], args[4]); 
            break;
          case 'clientResetHeroEvent':
            resetHero(args);
            break;
          case 'clientSyncHeroEvent':
            var hero = args;
            counter += 0.5;
            updateHero(hero);
            break;
        }
      }

      var gameClient = new GameClient(player.id, emitterCallback);
      var cpuGameClient = new CpuGameClient(enemy.id);
      
      // Game instance initiates setup (Player Clients will need to
      // respond)
      gameInstance.setup();

      // TODO: Command list needs to come down from server, separate instances
      // for each Hero
      var commands = [
          {name: 'Attack'},
          {name: 'Skill'},
          {name: 'Item'},
          {name: 'Defend'}
        ];

      // TODO: this should be somewhere better 
      for (var i = 0; i < gameClient.heroes.length; i++) {
        var curHero = gameClient.heroes[i];
        if (!curHero) { 
          continue;
        }

        // FIXME: here's that command list (shared instance!)
        curHero.commands = commands;
        var isYou = curHero.player.id == gameClient.myId;
        var heroDomId = 'hero_'+ curHero.id;
        var heroHp = curHero.attributes.hp;

        var heroPane = $("#party > tbody");
        if (!isYou) {
          heroPane = $("#enemy > tbody");
        }
        heroPane.append(heroRowTemplate({heroDomId: heroDomId, position: i, heroId: curHero.id, heroName: curHero.name, heroHp: heroHp}));

        heroRows[curHero.id] = $('#' + heroDomId);
        var onUpdate = function(val, isPositive) {
          var percent = val/this.hero.attributes.maxHp;
          var rgb = '#fff';
          if (isPositive) {	
            rgb = '#2e6';
          } else {
            if (percent < 0.3) {
              rgb = 'rgb(255,'+ (Math.round(percent/0.2*215)+40) + ',0)';
            } else if (percent < 0.6) {
              rgb = 'rgb(255,255,' + Math.round((percent-0.3)/0.3*255)+')';
            }
          }
          this.holder.text(val);
          this.holder.css('color', rgb);
        };
        onUpdate = _.bind(onUpdate, { holder: heroRows[curHero.id].find('.hp'), hero: curHero });
        hpIncrementers[curHero.id] = new atb.GradualIncrementer(heroHp, heroHp, onUpdate, 0.5);
      }

      // attach command carousel
      var commandCarousel = new atb.CommandCarousel($('#commands-anchor'));
      commandCarousel.paneWidth = 180;
      commandCarousel.onAdd = onAddRemoveCommandPanes;
      commandCarousel.onRemove = onAddRemoveCommandPanes;
      commandCarousel.onMoveStart = onCommandCarouselMoveStart;
      commandCarousel.onMoveEnd = onCommandCarouselMoveEnd;

      /** KEYBOARD INPUT SUPPORT **/

      // which menu is in focus and should be modified by keystrokes
      var activeMenu = null;
      function setActiveMenu(newActive) {
        activeMenu = newActive;
      }

      // Command menu keyboard input
      function comMenuKeyInputHandler(keyEvent) {
        switch(keyEvent.data.key) {
          case 'left':
            commandCarousel.moveRight();
            break;
          case 'right':
            commandCarousel.moveLeft();
            break;
          case 'up':
            this.items.moveCursor('up');
            break;
          case 'down':
            this.items.moveCursor('down');
            break;
          case 'action':
            // Action key
            var selected = this.items.curSelected.find('a');
            var commandPane = commandCarousel.getPaneInFocus();
            var actionType = $(selected).text().toLowerCase();
            processCommand(commandPane, actionType);
            break;
          default:
            // ignore
        }
      }

      function itemMenuKeyInputHandler(keyEvent) {
        switch(keyEvent.data.key) {
          case 'left':
          case 'right':
          case 'up':
          case 'down':
            this.items.moveCursor(keyEvent.data.key);
            break;
          case 'action':
            // Action key
            var selected = this.items.curSelected.find('a');
            var heroId = selected.attr('heroId');
            var hero = gameClient.heroes[heroId];
            var itemId = selected.prop('id');
            itemId = itemId.substr(itemId.lastIndexOf('_')+1);
            var actionType = 'item';
            openTargetMenu(hero, actionType, itemId, this);
            break;
          default:
            // ignore
        }
      }

      // Target menu keyboard input
      function tarMenuKeyInputHandler(keyEvent) {
        switch(keyEvent.data.key) {
          case 'left':
          case 'right':
          case 'up':
          case 'down':
            this.items.moveCursor(keyEvent.data.key);
            break;
          case 'action':
            // Action key
            var selected = this.items.curSelected.find('a');
            var actionType = selected.prop('class');
            var actorId = selected.attr('heroId');
            var targetId = selected.attr('targetId');
            var actionArgs = this.container.data('args');
            if (actionType == 'cancel') {
              // backtrack to command menu
              cancelTargetPane();
            } else {
              executeCommandOnTarget(actionType, actionArgs, actorId, targetId);
            }
            break;
          default:
            // ignore
        }
      }

      function keyInputHandler(keyEvent) {
        if (!activeMenu) {
          return;
        }
        activeMenu.onKeyInput(keyEvent);
        keyEvent.stopPropagation();
        return false;
      }

      $(document).on('keydown.left', {key:'left'}, keyInputHandler);
      $(document).on('keydown.right', {key:'right'}, keyInputHandler);
      $(document).on('keydown.up', {key:'up'}, keyInputHandler);
      $(document).on('keydown.down', {key:'down'}, keyInputHandler);
      $(document).on('keydown.space', {key:'action'}, keyInputHandler);
      $(document).on('keydown.return', {key:'action'}, keyInputHandler);

      /** END KEYBOARD INPUT SUPPORT */
    </script>
  </div>
  </body>
</html>
